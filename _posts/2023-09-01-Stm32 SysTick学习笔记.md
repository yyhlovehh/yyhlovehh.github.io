## Stm32 SysTick学习笔记

#### 1.简介

SysTick,即系统滴答定时器，包含在M3/4/7内核里面，核心是一个24为的递减计数器。

时钟源：AHB上的HCLK。

![SysTick1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202309010924155.png)

#### 2.寄存器

#### ![SysTick_2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202309010928139.png)![Systick3](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202309010929672.png)

#### 3.函数实现（F1为例）

`void delay_init(uint16_t sysclk) //72`
`{` 
	`SysTick->CTRL = 0;` //复位
	`HAL_SYSTICK_CLKSourceConfig(SYSTICK_CLKSOURCE_HCLK_DIV8);` 
	`g_fac_us = sysclk / 8;` //全局变量，1us对应的时钟周期个数
`}`



``void delay_us(uint32_t nus)` 
`{` 
	`uint32_t temp;` 
	`SysTick->LOAD = nus * g_fac_us; 	/* 时间重装载，nus微秒 */ 
	SysTick->VAL = 0x00; 			/* 清空计数器 */ 
	SysTick->CTRL |= 1 << 0 ; 		/* 开始倒数，使能滴答定时器，ENABLE位置1 */ 
	do 
	{ 
		temp = SysTick->CTRL; 
	} while ((temp & 0x01) && !(temp & (1 << 16))); /* CTRL.ENABLE位必须为1, 并等待时间到达 */`

`SysTick->CTRL &= ~(1 << 0) ; 		/* 关闭SYSTICK ，1<<0=1*/ *`

`*SysTick->VAL = 0X00; 			/* 清空计数器 */`



**微秒延时最大时间为：**1/(SYSCLK/8)*2^24  以168M为例，为798915us=798.915ms。



`void delay_ms(uint16_t nms)` 
`{` 
	`uint32_t repeat = nms / 500;	/* 这里用1000,是考虑到可能有超频应用,` 
							    	 `* 比如128Mhz的时候, delay_us最大只能延时1048576us` `*/` 
	`uint32_t remain = nms % 500;` 
	`while (repeat)` 
	`{` 
		`delay_us(500* 1000); 	/* 利用delay_us 实现 500ms延时 */` 
		`repeat--;` 
	`}` 
	`if (remain)` 
	`{` 
		`delay_us(remain * 1000); 	/* 利用delay_us, 把尾数延时(remain ms)给做了 */` 
	`}` 
`}`