## Stm32 DMA学习笔记

#### 1.DMA简介

- DMA(Direct Memory Access)直接存储器存取。
- DMA可以提供外设寄存器和存储器或者存储器和存储器之间得高速数据传输，无需CPU干预，节省了CPU的资源。
- 12个独立可配置的通道：DMA1(7个通道)，DMA2（5个通道）。
- 每个通道都支持软件触发和特定的硬件触发。软件触发一般用于存储器到存储器的数据转运，DMA会一股脑地把数据转运，而硬件触发一般用于外设寄存器到存储器的数据转运，因为外设寄存器的数据转运需要一定的时机，比如ADC转换完成后，才能进行数据的转运，可以设置每次转换完成后硬件触发一次DMA，进行数据转运。注意：每个DMA的硬件触发源是不一样的。

#### 2.Stm32存储器映像

#### <img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308190810277.png" alt="QQ截图20230819080746"  />

内核外设：NVIC和SysTick。

flash：是存储芯片的一种，又称闪存，通过特定的程序可以修改里面的数据；FLASH在电子以及半导体领域内往往表示Flash Memory的意思，即平时所说的“闪存”，全名叫**Flash EEPROM Memory**。CPU和DMA对flash只能读取数据，不能修改数据。

寄存器：是一种特殊的存储器。一方面，CPU可以对寄存器进行高速读写；另一方面，寄存器的输出可以控制各种外设的状态。因此，寄存器是连接硬件和软件的桥梁。

#### 3.DMA框图

![QQ截图20230819083927](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308190840283.png)

仲裁器：因为有很多通道要进行数据转运，采用总线分时间进行传输，如果同时请求数据转运，发生冲突，需要仲裁器判定优先级。

AHB从设备：DMA自身的寄存器。

DMA请求：连接各个外设，是DMA的触发源。

#### 4.DMA基本结构（江科大）

<img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308190907009.png" alt="QQ截图20230819090656" style="zoom:80%;" />

- **方向**

在stm32中，存储器一般特指主闪存flash和静态随机存储器SRAM，外设寄存器直接叫外设。DMA数据转运可以从外设到存储器、存储器到外设、存储器到存储器（只能flash到SRAM，因为flash只读），由方向参数控制。

- **数据转运参数**

起始地址：数据存储的地址。

数据宽度：一次转运多少位。

地址是否自增：这次转运完成后，下次转运的地址是否自增。例如转运ADC数据，ADC数据寄存器的地址不能自增，而存储器的地址要自增，让下次转运的数据存到下一个地址，不能覆盖上次的数据。

- **传输计数器**

是一个自减计数器，指定数据转运的次数。当计数器的值为0时，数据转运结束，并且地址会恢复到起始位置。

- **自动重装器**

决定转运模式。如果不重装，则为单组转运模式，计数器到0结束转运。如果重装，则为循环转运模式，计数器到0后被重装到一个值。例如ADC扫描模式加连续转换，第一组转换有好几个通道，将各个通道依次进行ADC转换后的数据转运，转运结束后计数器恰好为0，进行下一组数据转换，对应重装传输计数器进行下一组DMA数据转运。即指是不是立即开始下一轮数据转运。

- **触发模式**

软件触发：不断调用函数，快速的转运数据。不能和循环模式同时使用，因为软件触发就是想把传输计数器清零，而循环模式时清零后自动重装，同时用DMA无法停止。一般用于存储器到存储器的数据转运，因为不需要转运时机，想尽快完成。

硬件触发：需要数据的转运时机。例如ADC转换完成、串口收到数据、定时时间到等。

#### 5.DMA的开启与结束

##### 5.1DMA开始进行数据转运的条件：

1. 开关控制，DMA必须使能；
2. 传输计数器要大于零；
3. 要有触发源。

##### 5.2DMA停止数据转运情况：

1. 软件触发，采用不循环数据转运模式，计数器值为0结束。
2. 硬件触发，当传输计数器到0且不自动重装时，无论是否有触发源，DMA都会结束数据转运。
3. 硬件触发，采用循环模式，触发信号结束时，停止数据转运。

**注意：写传输计数器的值时，必须关闭DMA的使能。（手册规定）**

#### 6.DMA请求

![DMA请求映射](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308190946221.png)

DMA不同通道有不同的触发源。EN是控制通道选择器的使能信号；M2M是触发源控制信号，当为1时，是软件触发。每个外设都一个函数DMAcmd()，来开启外设的DMA请求，如果都开启，是或的关系。

默认优先级是通道号越小，优先级越高。也可以在程序中配置优先级。

#### 7.DMA数据宽度与对齐

![DMA数据宽度与对齐](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308190955701.png)

