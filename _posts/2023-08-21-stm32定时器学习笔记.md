## stm32定时器学习笔记

#### 1.Timer定时器

##### 1.1简介

- 定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断
- 16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时
- 不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能
- 根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型

定时器的本质就是一个计数器，只不过时钟是固定的，并且加了一个自动重装载计数器。

##### 1.2类型

![定时器类型](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308211035494.png)

主从触发模式：能让内部的硬件在不受程序的控制下实现自动运行。例如**主模式可以将定时器内部的事件映射到TRGO引脚**。

高级定时器对比通用定时器：

- 有一个重复次数计数器，可以实现每隔几个周期产生更新中断或事件，而通用定时器是每个计数周期都会发生更新，相当于对输出的更新信号做了一次分频。
- 有死区生成电路，之后为一个互补的输出，这些设计是为了驱动三相无刷电机的。死区生成电路是为了防止开关切换输出时由于器件的不理想，出现直通现象，即互补输出开关同时打开。
- 刹车输入，如果外部引脚BKIN或者内部时钟失效产生故障，控制电路自动切断电机的输出，防止意外发生。

#### 2.通用定时器

![通用定时器](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308211039498.png)

<div align = "center">通用定时器</div>

主要包含时基单元、输入捕获电路、比较输出电路以及时钟电路。

预分频、计数寄存器实际上有两个寄存器，一个寄存器用于实际控制，一个**缓冲（影子）寄存器**用于更新事件来临时才会将缓冲寄存器的值赋给实际控制的寄存器。计数器预装功能（有影子寄存器）可以被控制。

##### 时钟源：

- 内部时钟CK_INT，一般等于系统时钟SYSCLK
- 外部引脚时钟TIMx_ETR
- ITRx来自其他定时器的TRGO输出，实现定时器的级联
- TIMx_CHx输入的信号，经过滤波器和边沿检测器得到TI1F_ED(ED是指Edge,边沿的意思)，上升沿和下降沿均有效
- TIMx_CHx输入的信号，经过滤波器和边沿检测器得到上升沿信号TI1FP1
- TIMx_CHx输入的信号，经过滤波器和边沿检测器得到下降沿信号TI1FP2

#### 3.输出比较

- 输出比较可以通过比较CNT与CCR寄存器值的关系，来对输出电平进行置1、置0或翻转的操作，用于输出一定频率和占空比的PWM波形
- 每个高级定时器和通用定时器都拥有4个输出比较通道
- 高级定时器的前3个通道额外拥有死区生成和互补输出的功能

##### 3.1PWM简介

- PWM（Pulse Width Modulation）脉冲宽度调制
- 在具有惯性的系统中，可以通过对一系列脉冲的宽度进行调制，来等效地获得所需要的模拟参量，常应用于电机控速等领域
- PWM参数：
       	频率 = 1 / TS            占空比 = TON / TS           分辨率 = 占空比变化步距



<img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308211234250.png" alt="PWM2" style="zoom: 50%;" />

![PWM1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220736415.png)

##### 3.2输出比较通道

![输出比较通用框图](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308211238430.png)

- ETRF是定时器的一个小功能，一般不用。
- OC1ref可以映射到主模式的TRGO输出上；还可以到达极性选择电路，给CC1P寄存器写0，信号不翻转，写1信号翻转。
- 输出比较模式由寄存器CCMR控制。

![输出比较高级](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220239658.png)

输出比较的OC1和OC1N一般接CMOS电路（本质上就是大功率电子开关）的两个输入端，控制上管和下管的关闭和打开，同一时刻只能由一个MOS管导通。但是由于器件不理想，上管还没有完全关断，下管就已经导通了，出现了短则的上下管同时导通的现象。因此就有前面的死区发生器，它会在下管关闭的时候，延迟一小段时间，再导通上管，上管关闭的时候，延迟一小段时间，再导通下管，这样就可以避免上下管同时导通的现象了。

##### 3.3输出比较模式

| 冻结             | CNT=CCR时，REF保持为原状态                                   |
| ---------------- | ------------------------------------------------------------ |
| 匹配时置有效电平 | CNT=CCR时，REF置有效电平                                     |
| 匹配时置无效电平 | CNT=CCR时，REF置无效电平                                     |
| 匹配时电平翻转   | CNT=CCR时，REF电平翻转                                       |
| 强制为无效电平   | CNT与CCR无效，REF强制为无效电平                              |
| 强制为有效电平   | CNT与CCR无效，REF强制为有效电平                              |
| PWM模式1         | 向上计数：CNT<CCR时，REF置有效电平，CNT≥CCR时，REF置无效电平                                                                            向下计数：CNT>CCR时，REF置无效电平，CNT≤CCR时，REF置有效电平 |
| PWM模式2         | 向上计数：CNT<CCR时，REF置无效电平，CNT≥CCR时，REF置有效电平                                                                           向下计数：CNT>CCR时，REF置有效电平，CNT≤CCR时，REF置无效电平 |

作用：

- 冻结模式将REF保持原状态，想要停止输出PWM时，可以设置为该模式。
- 有效电平就是高电平，无效电平就是低电平的意思。
- 强制输出模式为无效电平或有效电平与冻结模式的功能差不多。

##### 3.4PWM基本结构（江科大）

![PWM基本结构](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308211237398.png)

##### 3.5PWM基本应用

1.PWM驱动舵机

- 舵机是一种根据输入PWM信号占空比来控制输出角度的装置
- 输入PWM信号要求：周期为20ms，高电平宽度为0.5ms~2.5ms

舵机图片：

<img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220255977.png" alt="舵机1"  />

![舵机2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220256238.png)

可以看出，舵机其实并不是一种单独的电机，内部是由直流电机驱动的，里边还有一个控制电路板。PWM信号输入到控制板，给控制板一个指定的目标角度。然后，电位器检测输出轴的当前角度，如果大于目标角度，电机反转，如果小于目标角度，电机正转，最终使输出轴固定在一个角度。

PWM信号：

![舵机3](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220257793.png)

硬件电路：

![舵机4](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220259445.png)



2.PWM驱动直流电机

- 直流电机是一种将电能转换为机械能的装置，有两个电极，当电极正接时，电机正转，当电极反接时，电机反转
- **直流电机属于大功率器件，GPIO口无法直接驱动，需要配合电机驱动电路来操作**
- TB6612是一款双路H桥型的直流电机驱动芯片，可以驱动两个直流电机并且控制其转速和方向![电机](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220305053.png)

H桥电路是由两个CMOS(推挽电路)组成的，上边为两个PMOS管，低电平导通；下边为两个NMOS管，高电平导通。中间O1、O2输出接电机，左边PMOS管导通、右边NMOS管导通，Uo1>Uo2,左边NMOS管导通、右边PMOS管导通，Uo1<Uo2，可以实现直流电机的正转和反转。

硬件电路图：

![电机1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308220351551.png)

IN1和IN2全为H,O1和O2全为L,没有电压差，电机不转；

IN1和IN2全为L,O1和O2输出关闭，电机不转；

IN1为L,IN2为H,PWM为H,电机反转，PWM为L,电机制动，PWM是一个快速翻转的信号，电机就不断反转、停止，如果PWM的频率足够高，电机就可以连续稳定地反转，并且速度取决于PWM的占空比；（PWM在这里的功能为使用PWM等效于一个模拟量）

IN1为H,IN2为L,PWM为H,电机正转，PWM为L,电机制动。

#### 4.输入捕获

#### 5.编码器

**使用PWM驱动电机，再使用编码器测量电机的速度，再用PID算法进行闭环控制。**

- 编码器接口可接收增量（正交）编码器的信号，根据编码器旋转产生的正交信号脉冲，自动控制CNT**自增或自减**，从而指示编码器的位置、旋转方向和旋转速度
- 每个高级定时器和通用定时器都拥有1个编码器接口
- 两个输入引脚借用了输入捕获的通道1和通道2，注意通道3、4不能用

##### 5.1正交编码器

![正交编码器](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308310446097.png)

编码器测速原理：CNT计数，每隔一定时间取值，得到多少个脉冲。转速越快，在单位时间内的脉冲数目就多，即方波频率越高。取任意一相信号就可以得出转速。要测旋转方向，需要另一相的方波。

编码器输入：通道1和通道2的边缘检测信号；

编码器输出：输入出现在哪一个表，控制CNT自增还是自减。

**注意：我们之前一直使用的定时器内部时钟CK_PSC和计数防线并不会起作用，因为此时计数时钟和计数方向都处于编码器托管的状态。计数器的自增和自减，受编码器控制。**

**正交信号优点：抗噪声能力好。**

##### 5.2编码器接口基本结构（江科大）

##### ![编码器接口基本结构](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308310508054.png)

**注意：极性选择高，代表是高低电平不翻转；选择低，代表电平翻转。**

调整极性的办法：任意一个引脚选择极性为低；A、B相两个引脚换一下。

##### 5.3工作模式

![编码器工作模式](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308310511956.png)

在TI1和TI2上计数：两个引脚的信号都可以控制CNT自增或自减。正转向上计数，反转向下计数。

