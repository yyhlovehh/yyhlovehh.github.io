## stm32串口学习笔记

#### 1.通信接口介绍

通信的目的：将一个设备的数据传送到另一个设备，扩展硬件系统。

通信协议：制定通信的规则，通信双方按照协议规则进行数据接收和发送

![通信协议](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200213773.png)

<div align = "center">通信协议</div>

时钟：同步指双方有一个共同的时钟控制。

电平：单端是指高低电平针对GND，通信双方必须共GND;差分高低电平是指靠两个引脚的电压差控制，抗干扰能力强。

设备：多设备采用总线。

#### 2.串口通信协议

##### 2.1串口通信简介

- 串口是一种应用十分广泛的通讯接口，串口成本低、容易使用、通信线路简单，可实现两个设备的互相通信

- 单片机的串口可以使单片机与单片机、单片机与电脑、单片机与各式各样的模块互相通信，极大地扩展了单片机的应用范围，增强了单片机系统的硬件实力

  <img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200225357.png" alt="串口硬件图" style="zoom:80%;" />

<div align = "center">串口硬件图</div>

**注意TX1接RX2,RX1接TX2。**

##### 2.2电平标准

电平标准是数据1和数据0的表达方式，是传输线缆中人为规定的电压与数据的对应关系，串口常用的电平标准有如下三种：

- TTL电平：+3.3V或+5V表示1，0V表示0
- RS232电平：-3~-15V表示1，+3~+15V表示0
- RS485电平：两线压差+2~+6V表示1，-2~-6V表示0（差分信号）

##### 2.3串口参数和通信时序

- 波特率：串口通信的速率。（因为是异步通信，必须在规定的时间内传输数据，决定了每隔多久发送一位数据）
- 起始位：标志一个数据帧的开始，固定为低电平
- 数据位：数据帧的有效载荷，1为高电平，0为低电平，**低位先行**
- 校验位：用于数据验证，根据数据位计算得来，判断数据是否出错。如果采用奇校验，连同校验位包含在内的9位为奇数个1，在传输中因为干扰某位由0变为1或由1变为0，奇校验出错，判定数据出错。
- 停止位：用于数据帧间隔，固定为高电平

![串口时序1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200235522.png)



![串口时序2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200235413.png)

#### 3.USART简介

- USART（Universal Synchronous/Asynchronous Receiver/Transmitter）通用同步/异步收发器
- USART是STM32内部集成的硬件外设，可根据数据寄存器的一个字节数据自动生成数据帧时序，从TX引脚发送出去，也可自动接RX引脚的数据帧时序，拼接为一个字节数据，存放在数据寄存器里
- 自带波特率发生器，最高达4.5Mbits/s
- 可配置数据位长度（8/9）、停止位长度（0.5/1/1.5/2）
- 可选校验位（无校验/奇校验/偶校验）
- 支持同步模式、硬件流控制、DMA、智能卡、IrDA、LIN

**PS:硬件流控制是指如果A设备传输数据太快，B设备接收时会覆盖之前接收的数据，采用硬件流控制，B和A之间会多一根线，当B接收数据完毕后，反馈给A，A才会传输下一个数据。可以防止因为B处理数据慢而导致数据丢失的问题。**

#### 4.USART框图

![串口框图](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200255952.png)

TX、RX为串口发送和接收引脚，其他引脚为智能卡SW、IRDA的引脚，此处不用管。TDR发送寄存器和RDR接收寄存器在硬件电路中是两个寄存器，但是地址一样，类似51单片机串口的SBUF。

移位寄存器可以将数据根据串口通信协议一位一位发送或接收。当要发送数据时，发送数据寄存器TDR将数据传输给移位寄存器，由移位寄存器将数据发送出去。这样做的好处时无论移位寄存器的数据是否发送完毕，发送寄存器TDR可以接收到下一个要发送的数据，一旦移位寄存器发送完毕，新的数据从发送数据寄存器TDR立刻转移到移位寄存器，提高数据发送的效率。

最后是波特率发生器，本质是分频器。

#### 5.USART基本结构（江科大）

![串口基本结构](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308200313074.png)

#### 6.串口发送问题

- 接收数据一直为0x0A：因为默认接收数据最后为0x0A换行
- 接收数据类型为char
- 发送换行需要两个转移字符\r\n
- 串口连接成功，只能发送不能接收数据，例如在小车中，设置定时器为中断为10ms会打断串口的数据接收。
- 粗心错误：RX接TX,TX接RX，那么提问：蓝牙设备插入单片机上，TTL也要插单片机，二者应该是RX-RX，TX-TX,他们的RX对应单片机的TX.
- HAL_Delay成为死循环导致串口发不出去，是由于中断优先级问题
- **注意串口中断通用处理函数会关闭串口接收中断的使能**
- ![串口_1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202309041024007.png)
- **注意接受指针指向的地址在接受数据后自动加1**
- ![串口_2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202309041035610.png)

#### 7.数据模式

- HEX模式/十六进制模式/二进制模式：以原始数据的形式显示

- 文本模式/字符模式：以原始数据编码后的形式显示

- ASCII码字符集（不能显示汉字）：

  ![ASCCI码](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308301048722.png)

如果想用汉字，就必须用汉字字符集，例如GB2312、GBK等。

#### 8.串口实现功能

**发送字节、数组、字符串、数字以及实现printf()函数。**

方法一：**将printf()的底层函数fputc重定向。**

![printf](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308301215736.png)

问题：上述方法printf()函数只能有一个，重定向到USART1，如果串口2、3要用printf()函数呢？或者是多个串口都想要printf函数呢？

方法二：**采用sprintf()函数，可以指定打印位置，不涉及重定向，每个串口都可以用sprintf()函数。**

`char String[100];`

`sprintf(String,"Num=%d\r\n",666);`

`USARTx_SendString(String);`

方法三：**封装sprintf()函数**

`#include"stdarg.h"`

`void USARTx_Printf(char *format,...)`//可变参数的用法很高级，可以学习以下！！

`{`

​	`char String[100];`

​	`va_list arg;`

​	`va_start(arg,format);`

​	`vsprintf(String,format,arg);`

​	`vs_end(arg);`

​	`USARTx_SendString(String);`

`}`

#### 9.数据包

HEX：

- 固定包长，含包头包尾

  ![HEX1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308302150725.png)

- 可变包长，含包头包尾

  ![HEX2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308302151932.png)

如果数据不会和包头包尾重复，可以选择可变包长，只要出现包头之后就是数据，出现包尾数据结束。

文本：

- 固定包长，含包头包尾

  ![文本1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308302156686.png)

- 可变包长，含包头包尾

  ![文本2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308302156038.png)

#### 10.数据包接收

利用状态机的编程思维：

HEX:

![HEX接收](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308310044482.png)

文本：

![接受2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308310045302.png)