## 智能小车开发

#### 1.stm32F407VE6 LQFP100开发板时钟

在system_stm32f4xx.c文件中，有F407时钟默认配置：

![F407时钟](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201155129.png)

在stm32中文参考手册中，有时钟框图：

![时钟](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201156244.png)

可以计算出F407芯片的时钟频率：

- 系统时钟SYSCLK：168MHZ
- AHB=168/1=168MHZ
- APB1=168/4=42MHZ
- APB2=168/2=84MHZ

**定时器8的时钟来自APB2,时钟频率为168MHZ。**

#### 2.PWM电机驱动

采用PWM驱动两个电机，使小车实现动起来。

##### 2.1电机接线

<img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201224246.png" alt="电机接线" style="zoom:50%;" />

直流电机的转速由输入电压的大小控制。

##### 2.2TB6612FNG芯片

直接改变电压的大小控制电机转速太麻烦，可以采用PWM将数字信号转为模拟信号，并利用微控制器进行电机转速控制。但是我们的单片机的 IO 带负载能力较弱， 而直流电机是大电流感性负载， 所以这里我们需要对 IO 输出的信号进行功率放大， 我们选择了TB6612FNG 驱动。  

TB6612FNG 是东芝半导体公司生产的一款直流电机驱动器件， 它具有大电流MOSFET-H 桥结构， 双通道电路输出， 可同时驱动 2 个电机。  **对于 PWM 信号输入频率范围， 高达 100 kHz 的频率更是足以满足我们大部分的需求了。**  （根据此处，可以设置PWM波频率为100kHz）

以下是 TB6612FNG 的主要参数 :

- 最大输入电压： VM = 15V
- 最大输出电流： Iout = 1.2A（平均） /3.2A（峰值）
- 正反转/短路刹车/停机功能模式
- 内置过热保护和低压检测电路

以下是 TB6612 模块测试一个电机的接线图：  

![电机芯片接线](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201235207.png)

VM 直接接电池即可， VCC 是内部的逻辑供电， 一般给 3.3 或者 5V 都行， 模块的 GND 一个接电源地， 一个接单片机地， **STBY 置高模块才能正常工作**。 完成上面的接线之后， 我们就可以开始控制电机了， 上图中红色部分的 5 个引脚控制一路电机， 蓝色部分的控制另外一路电机， 这里只讲其中的 A 路， B 路的使用是一样的。 AO1 和 AO2 分别接到电机的+和-。 然后通过 PWMA、 AIN2、 AIN1 控制电机。**其中 PWMA 接到单片机的 PWM 引脚， 一般 10Khz 的 PWM 即可**， 并通过改变占空比 来调节电机的速度。 下面是真值表 ：

![电机芯片真值表](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201239503.png)

- PWM 信号控制输出电压大小，从而达到控制转速的作用。
- AIN1 与 ANI2 信号一起控制电机的正反转以及停止状态 。
- 为什么需要编码器？编码器接口可接收增量（正交）编码器的信号，根据编码器旋转产生的正交信号脉冲，自动控制CNT自增或自减，从而指示编码器的位置、旋转方向和旋转速度
- AIN、AO输出是数字信号还是模拟信号？AIN是单片机输出的数字信号，AO是根据AIN输入以及PWM输入转换的两个模拟电压信号。

##### 2.3电机硬件电路

![电机硬件图](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308210543337.png)

由图得，AIN1对应PA3,AIN2对应PA2,PWMA对应PC6；BIN1对应PA4,BIN2对应PA5,PWMB对应PC7。因此，PA3、PA2应配置为输出模式，控制MotorA的选择方向，PC6输出PWM信号，控制MotorB的转速。同理，PA4、PA5应配置为输出模式，控制MotorB的旋转方向，PC7输出PWM信号，控制MotorB的转速。

#### 3.PWM舵机控制

采用PWM控制舵机旋转一定的角度，使小车实现转向。

#### 4.串口控制小车转向

电脑和小车实现串口通信，根据电脑发出的数据来控制PWM波形，进而控制小车转向。