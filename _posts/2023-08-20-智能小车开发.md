## 智能小车开发（源码为标准库）

#### 1.stm32F407VE6 LQFP100开发板时钟

在system_stm32f4xx.c文件中，有F407时钟默认配置：

![F407时钟](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201155129.png)

在stm32中文参考手册中，有时钟框图：

![时钟树](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308280019446.png)

可以计算出F407芯片的时钟频率：

- 系统时钟SYSCLK：168MHZ
- AHB=168/1=168MHZ
- APB1=168/4=42MHZ
- APB2=168/2=84MHZ

**定时器8的时钟来自APB2,时钟频率为168MHZ。**

HSE时钟：

![HSE时钟](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308280016251.png)

**注意这是重点重点重点：可以看出开发板HSE时钟为8MHz，因此配置系统时钟参数为M=8,N=336,P=2,Q=7，时钟来源为PLLCLK，得到SYSCLK=168MHZ。（此处参考图1以及根据实际HSE=8M设置，因为之前设置完全参考图1把M设为了25，导致PWM输出不正常）**

#### 2.PWM电机驱动

采用PWM驱动两个电机，使小车实现动起来。

##### 2.1电机接线

<img src="https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201224246.png" alt="电机接线" style="zoom:50%;" />

直流电机的转速由输入电压的大小控制。

##### 2.2TB6612FNG芯片

直接改变电压的大小控制电机转速太麻烦，可以采用PWM将数字信号转为模拟信号，并利用微控制器进行电机转速控制。但是我们的单片机的 IO 带负载能力较弱， 而直流电机是大电流感性负载， 所以这里我们需要对 IO 输出的信号进行功率放大， 我们选择了TB6612FNG 驱动。  

TB6612FNG 是东芝半导体公司生产的一款直流电机驱动器件， 它具有大电流MOSFET-H 桥结构， 双通道电路输出， 可同时驱动 2 个电机。  **对于 PWM 信号输入频率范围， 高达 100 kHz 的频率更是足以满足我们大部分的需求了。**  （根据此处，可以设置PWM波频率为100kHz）

以下是 TB6612FNG 的主要参数 :

- 最大输入电压： VM = 15V
- 最大输出电流： Iout = 1.2A（平均） /3.2A（峰值）
- 正反转/短路刹车/停机功能模式
- 内置过热保护和低压检测电路

以下是 TB6612 模块测试一个电机的接线图：  

![电机芯片接线](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201235207.png)

VM 直接接电池即可， VCC 是内部的逻辑供电， 一般给 3.3 或者 5V 都行， 模块的 GND 一个接电源地， 一个接单片机地， **STBY 置高模块才能正常工作**。 完成上面的接线之后， 我们就可以开始控制电机了， 上图中红色部分的 5 个引脚控制一路电机， 蓝色部分的控制另外一路电机， 这里只讲其中的 A 路， B 路的使用是一样的。 AO1 和 AO2 分别接到电机的+和-。 然后通过 PWMA、 AIN2、 AIN1 控制电机。**其中 PWMA 接到单片机的 PWM 引脚， 一般 10Khz 的 PWM 即可**， 并通过改变占空比 来调节电机的速度。 下面是真值表 ：

![电机芯片真值表](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308201239503.png)

- PWM 信号控制输出电压大小，从而达到控制转速的作用。
- AIN1 与 ANI2 信号一起控制电机的正反转以及停止状态 。
- 为什么需要编码器？编码器接口可接收增量（正交）编码器的信号，根据编码器旋转产生的正交信号脉冲，自动控制CNT自增或自减，从而指示编码器的位置、旋转方向和旋转速度
- AIN、AO输出是数字信号还是模拟信号？AIN是单片机输出的数字信号，AO是根据AIN输入以及PWM输入转换的两个模拟电压信号。

##### 2.3电机硬件电路

![电机硬件图](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308210543337.png)

由图得，AIN1对应PA3,AIN2对应PA2,PWMA对应PC6；BIN1对应PA4,BIN2对应PA5,PWMB对应PC7。因此，PA3、PA2应配置为输出模式，控制MotorA的选择方向，PC6输出PWM信号，控制MotorB的转速。同理，PA4、PA5应配置为输出模式，控制MotorB的旋转方向，PC7输出PWM信号，控制MotorB的转速。

##### 2.4stm32引脚配置

![引脚映射2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308210838478.png)

![引脚配置](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308210839839.png)

由图得，PWMA(PC6)和PWMB(PC7)可以复用为TIM8_CH1、TIM8_CH2或者TIM3_CH1、TIM3_CH2，因此定时器8和定时器3都能输出PWM来控制电机得转速。

#### 3.PWM舵机控制

采用PWM控制舵机旋转一定的角度，使小车实现转向。

##### 3.1舵机工作原理

工作原理是控制电路接收信号源的控制脉冲， 并驱动电机转动； 齿轮组将电机的速度成大倍数缩小， 并将电机的输出扭矩放大响应倍数， 然后输出； 电位器和齿轮组的末级一起转动， 测量舵机轴转动角度； 电路板检测并根据电位器判断舵机转动角度， 然后控制舵机转动到目标角度或保持在目标角度。 模拟舵机需要一个外部控制器（遥控器的接收机或者单片机） 产生脉宽调制信号来告诉舵机转动角度， 脉冲宽度是舵机控制器所需的编码信息。 舵机的控制脉冲周期 20ms，脉宽从 0.5ms-2.5ms， 分别对应-90 度到+90 度的位置(对于 180°舵机)。 如下图所示：  

![舵机_1](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308230935213.png)

需要强调的是一般来说舵机需要的电源一般都在 1A 以上， 所以我们在使用的时候一般都需要给舵机的电路单独的做一个稳压电源保证舵机的工作。  

##### 3.2舵机接线

![舵机_2](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308230944802.png)

H1是最右边的一列，电路板下面有标识。舵机PWM的输入线为PE14,对应F407芯片TIM1_CH4。

#### 4.蓝牙串口控制小车转向

电脑和小车实现蓝牙串口通信，根据电脑或手机发出的数据来控制PWM波形，进而控制小车转向。

![蓝牙模块](https://raw.githubusercontent.com/yyhlovehh/yyhlovehh.github.io/master/202308280026378.png)

查引脚复用表，将PD5、PD6配置为USART2的RX、TX引脚，编写程序实现对小车的控制。